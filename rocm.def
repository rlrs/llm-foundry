Bootstrap: docker
From: rocm/pytorch:latest

%post
# Install llm-foundry
git clone https://github.com/rlrs/llm-foundry
cd llm-foundry
pip install cmake packaging torch
pip install -e .
pip3 install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/rocm5.6 --upgrade

# Install flash-attention for ROCm
cd /
git clone --recurse-submodules -j8 -b flash_attention_for_rocm https://github.com/ROCmSoftwarePlatform/flash-attention
cd flash-attention
patch /opt/conda/envs/py_3.8/lib/python3.8/site-packages/torch/utils/hipify/hipify_python.py /llm-foundry/hipify_patch.patch # custom patch for newest pytorch√ü
python setup.py install
